<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Synthwave Mixer: Mobile Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body { margin: 0; overflow: hidden; background: #000; font-family: 'Press Start 2P', cursive; touch-action: none; /* Prevent pull-to-refresh on mobile */ }
        
        /* UI Overlay */
        #ui-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
            color: #fff;
            text-shadow: 2px 2px 0 #ff00de;
            z-index: 20;
        }

        /* HUD Styling */
        .hud-panel {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #00f6ff;
            padding: 15px;
            pointer-events: auto;
            border-radius: 5px;
            box-shadow: 0 0 10px #00f6ff;
            /* Scale down HUD slightly on mobile */
            transform-origin: top left;
        }

        h1 { font-size: 24px; margin: 0 0 10px 0; background: linear-gradient(to right, #ff00de, #00f6ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .controls-hint { font-size: 10px; color: #ccc; line-height: 1.5; }
        
        /* Buttons & Sliders */
        button {
            background: #ff00de; color: white; border: none; padding: 8px 12px;
            font-family: 'Press Start 2P'; font-size: 10px; cursor: pointer;
            margin-top: 5px; width: 100%; text-transform: uppercase;
            transition: 0.2s;
        }
        button:hover { background: #fff; color: #ff00de; box-shadow: 0 0 10px #fff; }
        button:active { transform: scale(0.95); }

        input[type=range] { width: 100%; margin: 5px 0; accent-color: #00f6ff; cursor: pointer; }
        label { font-size: 10px; color: #00f6ff; display: block; margin-top: 5px; }

        #speedometer { font-size: 32px; text-align: right; color: #ffe600; text-shadow: 2px 2px 0 #b20000; }
        
        /* --- NEW: Touch Controls --- */
        #touch-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            height: 120px;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            box-sizing: border-box;
            pointer-events: none; /* Allow clicks to pass through empty space */
            z-index: 30;
        }

        .control-group {
            pointer-events: auto;
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .btn-touch {
            width: 70px;
            height: 70px;
            background: rgba(0, 0, 0, 0.3);
            border: 3px solid #00f6ff;
            border-radius: 50%;
            color: #00f6ff;
            font-size: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            cursor: pointer;
            backdrop-filter: blur(2px);
            box-shadow: 0 0 10px rgba(0, 246, 255, 0.3);
            transition: all 0.1s;
        }

        .btn-touch:active, .btn-touch.active {
            background: rgba(0, 246, 255, 0.4);
            color: white;
            transform: scale(0.95);
            box-shadow: 0 0 20px #00f6ff;
        }

        /* Right side buttons styled for Turbo/Brake */
        .d-pad-right .btn-touch {
            border-color: #ff00de;
            color: #ff00de;
            box-shadow: 0 0 10px rgba(255, 0, 222, 0.3);
        }
        .d-pad-right .btn-touch:active, .d-pad-right .btn-touch.active {
            background: rgba(255, 0, 222, 0.4);
            color: white;
            box-shadow: 0 0 20px #ff00de;
        }

        /* Hide HUD on very small screens landscape to see game, or scale it */
        @media (max-height: 500px) {
            .hud-panel { transform: scale(0.7); }
        }
        /* -------------------------- */

        .scanlines {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
            display: none;
        }
        .vignette {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%);
            pointer-events: none;
            z-index: 11;
            display: none;
        }

        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 20px; }
    </style>
</head>
<body>

<div id="loading">載入 80s 模組中...</div>
<div class="scanlines" id="css-scanlines"></div>
<div class="vignette" id="css-vignette"></div>

<div id="ui-container">
    <div class="hud-panel" style="width: 250px;">
        <h1>霓虹預拌車</h1>
        <div class="controls-hint">
            [鍵盤] WASD / ⬆⬇⬅➡<br>
            [觸控] 螢幕下方虛擬按鍵<br>
        </div>
        <hr style="border-color: #00f6ff; opacity: 0.5;">
        
        <label>視覺主題</label>
        <button id="btn-theme">切換主題：邁阿密</button>

        <label>攝影機模式</label>
        <button id="btn-camera">模式：追車 (居中)</button>
        
        <label>CRT / 故障特效</label>
        <button id="btn-glitch">特效：關閉</button>

        <label>炫光強度 (Bloom)</label>
        <input type="range" id="slider-bloom" min="0" max="3" step="0.1" value="1.0">

        <label>環境亮度/對比</label>
        <input type="range" id="slider-brightness" min="0.5" max="2" step="0.1" value="1.1">
    </div>

    <div style="align-self: flex-end; text-align: right;">
        <div id="speedometer">60 KM/H</div>
        <div style="color: #00f6ff; font-size: 12px;">TURBO SYSTEM READY</div>
    </div>
</div>

<div id="touch-controls">
    <div class="control-group d-pad-left">
        <div class="btn-touch" data-key="ArrowLeft">⬅</div>
        <div class="btn-touch" data-key="ArrowRight">➡</div>
    </div>
    <div class="control-group d-pad-right">
        <div class="btn-touch" data-key="ArrowDown">⬇</div>
        <div class="btn-touch" data-key="ArrowUp">⬆</div>
    </div>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
    import { FilmPass } from 'three/addons/postprocessing/FilmPass.js';

    // --- Configuration & State ---
    const CONFIG = {
        speed: 60,
        turnSpeed: 0.8,
        tiltFactor: 0.3, 
        fovBase: 60,
        fovTurbo: 90,
        horizonZ: -250,
        cameraZPass: 20
    };

    const THEMES = [
        { name: '邁阿密', sky: 0x2b0033, grid: 0xff00de, sunTop: 0xffe600, sunBot: 0xff0055, fog: 0x2b0033 },
        { name: '網路', sky: 0x001133, grid: 0x00f6ff, sunTop: 0xffffff, sunBot: 0x00f6ff, fog: 0x001133 },
        { name: '黃金', sky: 0x111111, grid: 0xffaa00, sunTop: 0xffd700, sunBot: 0x996600, fog: 0x111111 }
    ];

    let currentThemeIdx = 0;
    let gameState = {
        speed: 0.5, 
        realSpeed: 60,
        steering: 0,
        turbo: false
    };

    // --- Scene Setup ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(THEMES[0].fog, 0.015);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 3, 8);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.toneMapping = THREE.ReinhardToneMapping;
    document.body.appendChild(renderer.domElement);

    // --- Assets Generation (Procedural) ---
    // Grid Road
    const gridVertexShader = `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`;
    const gridFragmentShader = `
        uniform float time; uniform vec3 color; varying vec2 vUv;
        void main() {
            vec2 grid = abs(fract(vUv * vec2(1.0, 20.0) + vec2(0.0, time)) - 0.5) / fwidth(vUv * vec2(1.0, 20.0));
            float line = min(grid.x, grid.y);
            float fade = 1.0 - vUv.y; 
            gl_FragColor = vec4(color * (1.0 - min(line, 1.0)), fade * max(0.0, (1.0 - min(line, 1.0))));
        }
    `;
    const gridUniforms = { time: { value: 0 }, color: { value: new THREE.Color(THEMES[0].grid) } };
    const road = new THREE.Mesh(new THREE.PlaneGeometry(40, 300).rotateX(-Math.PI / 2).translate(0,0,-100), new THREE.ShaderMaterial({ uniforms: gridUniforms, vertexShader: gridVertexShader, fragmentShader: gridFragmentShader, transparent: true, side: THREE.DoubleSide }));
    scene.add(road);

    // Sun
    const sunMat = new THREE.ShaderMaterial({
        uniforms: { colorTop: { value: new THREE.Color(THEMES[0].sunTop) }, colorBot: { value: new THREE.Color(THEMES[0].sunBot) } },
        vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
        fragmentShader: `uniform vec3 colorTop; uniform vec3 colorBot; varying vec2 vUv; void main() { float y = vUv.y; float stripe = step(0.5, sin(y * 40.0)); if (y < 0.5 && stripe < 0.1) discard; gl_FragColor = vec4(mix(colorBot, colorTop, y), 1.0); }`,
        transparent: true
    });
    const sun = new THREE.Mesh(new THREE.CircleGeometry(25, 32), sunMat);
    sun.position.set(0, 15, -200); 
    scene.add(sun);

    // Buildings
    const buildings = [];
    const buildingGeo = new THREE.BoxGeometry(1, 1, 1);
    buildingGeo.translate(0, 0.5, 0); 
    function resetBuilding(b) {
        b.position.z = CONFIG.horizonZ + Math.random() * 50;
        const side = Math.random() > 0.5 ? 1 : -1;
        b.position.x = side * (20 + Math.random() * 15);
        b.scale.set(5 + Math.random() * 10, 10 + Math.random() * 40, 5 + Math.random() * 10);
        if (b.material) b.material.color.setHex(THEMES[currentThemeIdx].grid);
    }
    for (let i = 0; i < 30; i++) {
        const mat = new THREE.MeshBasicMaterial({ color: THEMES[0].grid, wireframe: true, transparent: true, opacity: 0.6, fog: true });
        const b = new THREE.Mesh(buildingGeo, mat);
        resetBuilding(b);
        b.position.z = CONFIG.horizonZ + (i / 30) * (CONFIG.cameraZPass - CONFIG.horizonZ);
        scene.add(b);
        buildings.push(b);
    }

    // Truck (Facing -Z)
    const truckGroup = new THREE.Group();
    const chassisMat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.2 });
    const cabinMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.1, metalness: 0.5 });
    const drumMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.3, metalness: 0.4, flatShading: true });

    const chassis = new THREE.Mesh(new THREE.BoxGeometry(2, 0.8, 6), chassisMat); chassis.position.y = 0.8; truckGroup.add(chassis);
    const cabin = new THREE.Mesh(new THREE.BoxGeometry(2, 1.8, 1.5), cabinMat); cabin.position.set(0, 1.8, -1.8); truckGroup.add(cabin);
    const windshield = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.8, 0.1), new THREE.MeshStandardMaterial({ color: 0x000000, roughness: 0, metalness: 0.9 })); windshield.position.set(0, 2.0, -2.56); truckGroup.add(windshield);

    const drumGeo = new THREE.CylinderGeometry(1.3, 0.5, 3.5, 7
